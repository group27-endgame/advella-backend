name: Build, Test and Deploy

env:
  MSSQL_DB_IP: ${{ secrets.MSSQL_DB_IP }}
  MSSQL_DB_NAME: ${{ secrets.MSSQL_DB_NAME }}
  MSSQL_DB_USERNAME: ${{ secrets.MSSQL_DB_USERNAME }}
  MSSQL_DB_PASSWORD: ${{ secrets.MSSQL_DB_PASSWORD }}

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
    
jobs:
#   build-and-test:
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Set up Java version
#       uses: actions/setup-java@v1
#       with:
#         java-version: '17'
        
#     - name: Create config
#       run: |
#         mkdir -p ${GITHUB_WORKSPACE}/src/main/resources && touch ${GITHUB_WORKSPACE}/src/main/resources/application.properties
#         echo "${{ secrets.CONFIG_FILE }}" > ${GITHUB_WORKSPACE}/src/main/resources/application.properties

#     - name: Test
#       run: mvn test -Dtest="com.advella.**"
#     - name: Build
#       run: mvn clean install

  deploy:
    runs-on: ubuntu-latest
#     needs: build-and-test
    steps:
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          command_timeout: 200m
          script: |
            docker build https://github.com/group27-endgame/advella-backend.git#main -t advella-backend
            
            docker rm -f advella-backend
            
            docker run -d \
            --name=advella-backend \
            --network=advella \
            -p 3000:8080 \
            --restart unless-stopped \
            -v /home/containers/advella-backend:/app
            -e DB_HOST=${{ secrets.DB_HOST }}
            -e DB_NAME=${{ secrets.DB_HOST }}
            -e DB_USER=${{ secrets.DB_HOST }}
            -e DB_PASS=${{ secrets.DB_HOST }}
            advella-backend
            
